<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Panel Admin - Mini E-commerce</title>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      margin: 0;
      color: #e6edf3;
      background:
        radial-gradient(60vw 60vh at 10% 20%, rgba(99, 102, 241, .35), transparent 55%),
        radial-gradient(50vw 50vh at 90% 10%, rgba(34, 197, 94, .25), transparent 60%),
        radial-gradient(55vw 55vh at 10% 90%, rgba(2, 132, 199, .30), transparent 60%),
        radial-gradient(45vw 45vh at 75% 80%, rgba(244, 114, 182, .28), transparent 60%),
        linear-gradient(135deg, #0b1220, #1f2937 65%, #0b1220);
      background-size: 120% 120%;
      animation: bg-move 18s ease-in-out infinite;
      background-attachment: fixed;
    }

    @keyframes bg-move {
      0% {
        background-position: 0% 0%, 100% 0%, 0% 100%, 100% 100%, 50% 50%;
      }

      50% {
        background-position: 40% 20%, 60% 0%, 20% 80%, 80% 60%, 50% 50%;
      }

      100% {
        background-position: 0% 0%, 100% 0%, 0% 100%, 100% 100%, 50% 50%;
      }
    }

    header {
      padding: 16px 20px;
      background: rgba(21, 24, 33, .75);
      border-bottom: 1px solid #252a36;
      backdrop-filter: saturate(140%) blur(8px);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    h1 {
      margin: 0;
      font-size: 20px;
    }

    main {
      max-width: 1100px;
      margin: 20px auto;
      padding: 0 16px;
    }

    .card {
      background: #151821;
      border: 1px solid #252a36;
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 16px;
    }

    .grid {
      display: grid;
      gap: 16px;
      grid-template-columns: 1fr;
    }

    @media (min-width: 900px) {
      .grid {
        grid-template-columns: 1fr 1fr;
      }
    }

    input,
    select,
    button,
    textarea {
      background: #0e0f12;
      border: 1px solid #2b3242;
      color: #e6edf3;
      padding: 8px;
      border-radius: 8px;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      background: #1f6feb;
      border-color: #1f6feb;
    }

    button.secondary {
      background: transparent;
      border-color: #2b3242;
    }

    /* Tabla a ancho completo y estilos mejorados */
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow: hidden;
      border-radius: 10px;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #0e0f12;
      z-index: 1;
    }

    th,
    td {
      border-bottom: 1px solid #2b3242;
      padding: 10px;
      font-size: 13px;
      text-align: center;
      vertical-align: middle;
    }

    tbody tr:hover {
      background: rgba(31, 111, 235, .08);
    }

    tbody tr:nth-child(odd) {
      background: rgba(14, 15, 18, .35);
    }

    .row {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    /* Filtros ocupan todo el ancho del contenedor */
    .filters input#filterId {
      max-width: 120px;
    }

    .filters input#filterName {
      flex: 1;
    }

    .filters select#filterCategory {
      min-width: 220px;
    }

    .filters button {
      padding: 10px 14px;
    }

    .muted {
      color: #9aa7b9;
      font-size: 12px;
    }

    .error {
      color: #ff6b6b;
    }

    .success {
      color: #6bc46d;
    }

    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 12px;
    }

    .tabs button {
      padding: 10px 14px;
      border-radius: 999px;
      border: 1px solid #2b3242;
      background: rgba(14, 15, 18, .6);
    }

    .tabs button.tab-active {
      background: #1f6feb;
      border-color: #1f6feb;
      color: #fff;
    }

    .hidden {
      display: none;
    }

    .empty {
      color: #9aa7b9;
      padding: 12px;
      text-align: center;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(9, 12, 20, .65);
      backdrop-filter: blur(6px);
      z-index: 50;
    }

    .modal {
      width: min(900px, 92vw);
      background: #0f1218;
      border: 1px solid #2b3242;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, .45);
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-top: 10px;
    }

    .title {
      margin: 0 0 8px;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-bar">
      <div>
        <h1>Panel Admin - Mini E-commerce</h1>
        <div class="muted">Gestiona productos y revisa pedidos</div>
      </div>
      <div class="header-right">
        <div id="authState" class="muted">No autenticado</div>
        <button id="logoutBtn" class="secondary">Cerrar sesión</button>
      </div>
    </div>
  </header>
  <main>
    <div id="authMsg" class="muted" style="margin-top:6px;"></div>

    <div class="card">
      <div class="tabs">
        <button id="tabProductos" class="tab-active">Productos</button>
        <button id="tabPedidos" class="secondary">Pedidos</button>
        <button id="tabCrear" class="secondary">Crear productos</button>
      </div>
      <div id="productosView">
        <h2>Productos</h2>
        <div class="filters row">
          <input id="filterId" placeholder="ID" />
          <input id="filterName" placeholder="Buscar por nombre" />
          <select id="filterCategory">
            <option value="">Todas las categorías</option>
          </select>
          <button id="applyFilters">Filtrar</button>
          <button id="clearFilters" class="secondary">Limpiar</button>
        </div>
        <div class="grid" style="grid-template-columns: 1fr;">
          <div>
            <h3>Resultados</h3>
            <div id="productsEmpty" class="empty">Usa los filtros para buscar productos.</div>
            <table>
              <thead>
                <tr>
                  <th>ID</th>
                  <th>Nombre</th>
                  <th>Precio</th>
                  <th>Stock</th>
                  <th>Categoría</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody id="productsTable"></tbody>
            </table>
          </div>
        </div>
      </div>
      <div id="pedidosView" class="hidden">
        <h2>Pedidos</h2>
        <table>
          <thead>
            <tr>
              <th>ID</th>
              <th>Cliente</th>
              <th>Email</th>
              <th>Total</th>
              <th>Status</th>
              <th>Fecha</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="ordersTable"></tbody>
        </table>
        <div id="orderDetail" class="card hidden" style="margin-top:10px;"></div>
      </div>
      <div id="crearView" class="hidden">
        <h2>Crear producto</h2>
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <input id="p_name" placeholder="Nombre" />
          <input id="p_price" placeholder="Precio" type="number" step="0.01" />
          <input id="p_stock" placeholder="Stock" type="number" />
          <input id="p_image" placeholder="Imagen URL (opcional)" />
          <input id="p_image_file" type="file" accept="image/*" />
          <input id="p_category" placeholder="Categoría (opcional)" />
          <textarea id="p_desc" placeholder="Descripción" style="grid-column:1 / -1;"></textarea>
          <button id="createProductBtn" style="grid-column:1 / -1;">Crear</button>
          <div id="createMsg" class="muted" style="grid-column:1 / -1;"></div>
        </div>
      </div>
    </div>
    <!-- Modal edición -->
    <div id="editBackdrop" class="modal-backdrop">
      <div class="modal">
        <h3 class="title">Editar producto</h3>
        <div class="grid" style="grid-template-columns:1fr 1fr;">
          <input id="e_name" placeholder="Nombre" />
          <input id="e_price" type="number" step="0.01" placeholder="Precio" />
          <input id="e_stock" type="number" placeholder="Stock" />
          <input id="e_image" placeholder="Imagen URL" />
          <input id="e_image_file" type="file" accept="image/*" />
          <input id="e_category" placeholder="Categoría" />
          <textarea id="e_desc" placeholder="Descripción" style="grid-column:1 / -1;"></textarea>
        </div>
        <div id="editMsg" class="muted" style="margin-top:6px;"></div>
        <div class="actions">
          <button id="editCancel" class="secondary">Cancelar</button>
          <button id="editSave">Guardar</button>
        </div>
      </div>
    </div>

  </main>

  <script>
    const authState = document.getElementById('authState');
    const authMsg = document.getElementById('authMsg');
    const logoutBtn = document.getElementById('logoutBtn');
    const tabProductos = document.getElementById('tabProductos');
    const tabPedidos = document.getElementById('tabPedidos');
    const tabCrear = document.getElementById('tabCrear');
    const productosView = document.getElementById('productosView');
    const pedidosView = document.getElementById('pedidosView');
    const crearView = document.getElementById('crearView');
    const productsTable = document.getElementById('productsTable');
    const productsEmpty = document.getElementById('productsEmpty');
    const filterId = document.getElementById('filterId');
    const filterName = document.getElementById('filterName');
    const filterCategory = document.getElementById('filterCategory');
    const applyFilters = document.getElementById('applyFilters');
    const clearFilters = document.getElementById('clearFilters');
    const ordersTable = document.getElementById('ordersTable');
    const orderDetail = document.getElementById('orderDetail');
    const editBackdrop = document.getElementById('editBackdrop');
    const e_name = document.getElementById('e_name');
    const e_price = document.getElementById('e_price');
    const e_stock = document.getElementById('e_stock');
    const e_image = document.getElementById('e_image');
    const e_image_file = document.getElementById('e_image_file');
    const e_category = document.getElementById('e_category');
    const e_desc = document.getElementById('e_desc');
    const editMsg = document.getElementById('editMsg');
    const editCancel = document.getElementById('editCancel');
    const editSave = document.getElementById('editSave');
    let editId = null;

    function formatMoney(value) {
      const n = Number(value || 0).toFixed(2);
      return '$' + n.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
    }

    function setTab(view) {
      const show = (el) => el.classList.remove('hidden');
      const hide = (el) => el.classList.add('hidden');
      const activate = (btn) => { btn.classList.add('tab-active'); btn.classList.remove('secondary'); };
      const deactivate = (btn) => { btn.classList.remove('tab-active'); btn.classList.add('secondary'); };
      if (view === 'productos') {
        show(productosView); hide(pedidosView); hide(crearView);
        activate(tabProductos); deactivate(tabPedidos); deactivate(tabCrear);
      } else if (view === 'pedidos') {
        hide(productosView); show(pedidosView); hide(crearView);
        deactivate(tabProductos); activate(tabPedidos); deactivate(tabCrear);
        loadOrders();
      } else {
        hide(productosView); hide(pedidosView); show(crearView);
        deactivate(tabProductos); deactivate(tabPedidos); activate(tabCrear);
      }
    }

    tabProductos.addEventListener('click', () => setTab('productos'));
    tabPedidos.addEventListener('click', () => setTab('pedidos'));
    tabCrear.addEventListener('click', () => setTab('crear'));
    setTab('productos');

    async function refreshAuth() {
      try {
        const r = await fetch('/api/auth/me');
        const j = await r.json();
        if (j.success) {
          authState.textContent = `Autenticado: ${j.user.username}`;
          authMsg.textContent = '';
        } else {
          authState.textContent = 'No autenticado';
        }
      } catch (e) {
        authMsg.textContent = 'Error consultando sesión';
      }
    }



    logoutBtn.addEventListener('click', async () => {
      authMsg.textContent = '';
      try {
        const r = await fetch('/api/auth/logout', { method: 'POST' });
        const j = await r.json();
        if (j.success) {
          // Redirigir al login para poder cambiar de rol fácilmente
          window.location.href = '/projects/mini-ecommerce/login/';
        } else {
          authMsg.textContent = j.error || 'No se pudo cerrar sesión';
          authMsg.className = 'muted error';
        }
      } catch (e) {
        // Si hay error, intentar redirigir igualmente
        window.location.href = '/projects/mini-ecommerce/login/';
      }
    });

    function parseCategory(desc) {
      const m = (desc || '').match(/\[\[(?:cat|categoria):([^\]]+)\]\]/i);
      return m ? m[1].trim() : '';
    }
    function renderProducts(list) {
      // Construir opciones de categorías preferentemente desde el campo real, con fallback al marcador
      const cats = new Set(['']);
      list.forEach(p => { const c = (p.category || parseCategory(p.description) || '').trim(); if (c) cats.add(c); });
      filterCategory.innerHTML = '<option value="">Todas las categorías</option>' + Array.from(cats).filter(c => c).map(c => `<option value="${c}">${c}</option>`).join('');
      productsTable.innerHTML = '';
      if (!list || list.length === 0) {
        productsEmpty.style.display = 'block';
        return;
      } else {
        productsEmpty.style.display = 'none';
      }
      list.forEach(p => {
        const tr = document.createElement('tr');
        const cat = p.category || parseCategory(p.description) || '-';
        tr.innerHTML = `
          <td>${p.id}</td>
          <td>${p.name}</td>
          <td>${formatMoney(p.price)}</td>
          <td>${p.stock}</td>
          <td>${cat}</td>
          <td>
            <button data-id="${p.id}" class="editBtn">Editar</button>
            <button data-id="${p.id}" class="delBtn secondary">Eliminar</button>
          </td>
        `;
        productsTable.appendChild(tr);
      });
      productsTable.querySelectorAll('.delBtn').forEach(btn => {
        btn.addEventListener('click', () => deleteProduct(Number(btn.getAttribute('data-id'))));
      });
      productsTable.querySelectorAll('.editBtn').forEach(btn => {
        btn.addEventListener('click', () => openEditProduct(Number(btn.getAttribute('data-id'))));
      });
    }

    async function loadProducts() {
      try {
        const id = filterId.value.trim();
        const q = filterName.value.trim();
        const cat = filterCategory.value.trim();
        let url = '/api/ecommerce/products';
        const params = new URLSearchParams();
        if (id) {
          params.set('id', id);
        } else {
          if (q) params.set('q', q);
          if (cat) params.set('category', cat);
        }
        if (params.toString()) url += `?${params.toString()}`;
        const r = await fetch(url);
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Error cargando productos');
        renderProducts(j.data);
      } catch (e) {
        productsEmpty.style.display = 'none';
        productsTable.innerHTML = `<tr><td colspan="6" class="error">${e.message}</td></tr>`;
      }
    }
    applyFilters.addEventListener('click', loadProducts);
    clearFilters.addEventListener('click', () => { filterId.value = ''; filterName.value = ''; filterCategory.value = ''; productsTable.innerHTML = ''; productsEmpty.style.display = 'block'; });

    async function createProduct() {
      const name = document.getElementById('p_name').value.trim();
      const price = document.getElementById('p_price').value;
      const stock = document.getElementById('p_stock').value;
      let image_url = document.getElementById('p_image').value.trim();
      const image_file = document.getElementById('p_image_file').files?.[0];
      const category = document.getElementById('p_category').value.trim();
      const description = document.getElementById('p_desc').value.trim();
      const createMsg = document.getElementById('createMsg');
      createMsg.textContent = '';
      try {
        if (image_file && !image_url) {
          image_url = await new Promise((resolve, reject) => {
            const reader = new FileReader(); reader.onload = () => resolve(reader.result); reader.onerror = reject; reader.readAsDataURL(image_file);
          });
        }
        const r = await fetch('/api/ecommerce/admin/products', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, price, stock, image_url, description, category })
        });
        const j = await r.json();
        if (j.success) {
          createMsg.textContent = 'Producto creado (ID ' + j.data.id + ')';
          createMsg.className = 'muted success';
          loadProducts();
          document.getElementById('p_name').value = '';
          document.getElementById('p_price').value = '';
          document.getElementById('p_stock').value = '';
          document.getElementById('p_image').value = '';
          document.getElementById('p_image_file').value = '';
          document.getElementById('p_category').value = '';
          document.getElementById('p_desc').value = '';
        } else {
          createMsg.textContent = j.error || 'No se pudo crear producto';
          createMsg.className = 'muted error';
        }
      } catch (e) {
        createMsg.textContent = 'Error conectando con el servidor';
        createMsg.className = 'muted error';
      }
    }
    document.getElementById('createProductBtn').addEventListener('click', createProduct);

    function openEditProduct(id) {
      // Obtener datos del producto actual desde la tabla
      const row = Array.from(productsTable.children).find(tr => Number(tr.children[0].textContent) === id);
      if (!row) return;
      const name = row.children[1].textContent;
      const price = parseFloat(row.children[2].textContent.replace('$', ''));
      const stock = parseInt(row.children[3].textContent);
      const category = row.children[4].textContent === '-' ? '' : row.children[4].textContent;
      // Cargar datos actuales (consultar descripción e imagen)
      fetch(`/api/ecommerce/products?id=${id}`).then(r => r.json()).then(j => {
        const p = (j.data || [])[0] || { description: '', image_url: '', category: '' };
        e_name.value = name; e_price.value = price; e_stock.value = stock; e_image.value = p.image_url || ''; e_category.value = (p.category || category || ''); e_desc.value = p.description || '';
        editMsg.textContent = ''; editMsg.className = 'muted'; editId = id;
        editBackdrop.style.display = 'flex';
      });
    }
    function closeEdit() { editBackdrop.style.display = 'none'; editId = null; }
    editCancel.addEventListener('click', closeEdit);
    e_image_file.addEventListener('change', async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => { e_image.value = reader.result; };
      reader.readAsDataURL(file);
    });
    editSave.addEventListener('click', async () => {
      if (!editId) return;
      const name = e_name.value.trim(); const price = e_price.value; const stock = e_stock.value;
      const description = e_desc.value || '';
      const cat = e_category.value.trim();
      const image_url = e_image.value.trim();
      editMsg.textContent = '';
      try {
        const r = await fetch(`/api/ecommerce/admin/products/${editId}`, {
          method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ name, price, stock, description, image_url, category: cat })
        });
        const j = await r.json();
        if (j.success) { editMsg.textContent = 'Actualizado'; editMsg.className = 'muted success'; closeEdit(); loadProducts(); }
        else { editMsg.textContent = j.error || 'No se pudo actualizar'; editMsg.className = 'muted error'; }
      } catch (e) { editMsg.textContent = 'Error conectando con el servidor'; editMsg.className = 'muted error'; }
    });

    async function deleteProduct(id) {
      try {
        const r = await fetch(`/api/ecommerce/admin/products/${id}`, { method: 'DELETE' });
        const j = await r.json();
        if (j.success) {
          loadProducts();
        } else {
          alert(j.error || 'No se pudo eliminar');
        }
      } catch (e) {
        alert('Error conectando con el servidor');
      }
    }

    async function loadOrders() {
      try {
        const r = await fetch('/api/ecommerce/admin/orders');
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'No se pudieron cargar pedidos');
        ordersTable.innerHTML = '';
        j.data.forEach(o => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${o.id}</td>
            <td>${o.customer_name || ''}</td>
            <td>${o.customer_email || ''}</td>
            <td>${formatMoney(o.total)}</td>
            <td>${o.status}</td>
            <td>${o.created_at}</td>
            <td><button class="secondary" data-id="${o.id}">Ver</button></td>
          `;
          ordersTable.appendChild(tr);
        });
        ordersTable.querySelectorAll('button').forEach(btn => {
          btn.addEventListener('click', () => loadOrderDetail(Number(btn.getAttribute('data-id'))));
        });
      } catch (e) {
        ordersTable.innerHTML = `<tr><td colspan="7" class="error">${e.message}</td></tr>`;
      }
    }

    async function loadOrderDetail(id) {
      try {
        const r = await fetch(`/api/ecommerce/admin/orders/${id}`);
        const j = await r.json();
        if (!j.success) throw new Error(j.error || 'Pedido no encontrado');
        const o = j.data;
        orderDetail.classList.remove('hidden');
        orderDetail.innerHTML = `
          <h3>Pedido #${o.id}</h3>
          <div class="muted">${o.customer_name || ''} - ${o.customer_email || ''}</div>
          <div>Total: ${formatMoney(o.total)} | Status: ${o.status} | Fecha: ${o.created_at}</div>
          <h4>Items</h4>
          <table style="margin-top:6px;">
            <thead><tr><th>Producto</th><th>Cant.</th><th>Precio</th></tr></thead>
            <tbody>
              ${o.items.map(i => `<tr><td>${i.name}</td><td>${i.quantity}</td><td>${formatMoney(i.unit_price)}</td></tr>`).join('')}
            </tbody>
          </table>
        `;
      } catch (e) {
        orderDetail.classList.remove('hidden');
        orderDetail.innerHTML = `<div class="error">${e.message}</div>`;
      }
    }

    async function ensureAdmin() {
      try {
        const res = await fetch('/api/auth/me');
        const me = await res.json();
        if (!me.success || me.user?.role !== 'admin') {
          window.location.href = '/projects/mini-ecommerce/login/';
          return false;
        }
        authState.textContent = `Autenticado: ${me.user.username}`;
        authMsg.textContent = '';
        return me.user;
      } catch (e) {
        window.location.href = '/projects/mini-ecommerce/login/';
        return false;
      }
    }

    // Inicialización
    (async () => {
      const user = await ensureAdmin();
      if (!user) return;
      // La lista de productos inicia vacía; el admin debe aplicar filtros.
    })();
  </script>
</body>

</html>