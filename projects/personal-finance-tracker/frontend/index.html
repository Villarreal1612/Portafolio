<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Finance Tracker</title>

    <!-- CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <link href="alerts.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- jsPDF y AutoTable para exportar a PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"
        integrity="sha512-Y0qJwV8d3kPQuqQ3WgCwB4N1KfVqjCMoXwX6I0oN7IuQwP5E80+v1h5fF6zqHf2X+S4b2D7u7pGm3LeGvHShwQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"
        integrity="sha512-3UFm1Hvyv8S8SgqZvCvIYFvW1mdp4zNyG9kFfD4P7VxBoWOPoFv6p0Vh+2oP1K6H3N6S3oX2mA4K1YvY3O1G6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</head>

<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1><i class="fas fa-chart-line"></i> Personal Finance Tracker</h1>
            <p>Gestiona tus ingresos y gastos de manera inteligente</p>
        </div>
    </div>

    <div class="container">
        <!-- Navegación por pestañas -->
        <ul class="nav nav-tabs" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard"
                    type="button" role="tab">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="transactions-tab" data-bs-toggle="tab" data-bs-target="#transactions"
                    type="button" role="tab">
                    <i class="fas fa-exchange-alt"></i> Transacciones
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="reports-tab" data-bs-toggle="tab" data-bs-target="#reports" type="button"
                    role="tab">
                    <i class="fas fa-chart-pie"></i> Reportes
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="import-export-tab" data-bs-toggle="tab" data-bs-target="#import-export"
                    type="button" role="tab">
                    <i class="fas fa-file-pdf"></i> Importar/Exportar
                </button>
            </li>
        </ul>

        <!-- Contenido de las pestañas -->
        <div class="tab-content" id="mainTabContent">
            <!-- Dashboard -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <!-- Estadísticas principales -->
                <div class="stats-grid">
                    <div class="stat-card income">
                        <div class="stat-value" id="totalIncome">$0.00</div>
                        <div class="stat-label">Ingresos del Mes</div>
                    </div>
                    <div class="stat-card expense">
                        <div class="stat-value" id="totalExpense">$0.00</div>
                        <div class="stat-label">Gastos del Mes</div>
                    </div>
                    <div class="stat-card balance">
                        <div class="stat-value" id="balance">$0.00</div>
                        <div class="stat-label">Balance</div>
                    </div>
                </div>

                <!-- Formulario de nueva transacción -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-plus-circle"></i> Nueva Transacción</h5>
                    </div>
                    <div class="card-body">
                        <form id="transactionForm">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Tipo</label>
                                        <select class="form-control form-select" id="transactionType" required>
                                            <option value="">Seleccionar...</option>
                                            <option value="income">Ingreso</option>
                                            <option value="expense">Gasto</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Monto</label>
                                        <input type="number" class="form-control" id="amount" step="0.01" min="0"
                                            required>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Categoría</label>
                                        <select class="form-control form-select" id="category" required>
                                            <option value="">Seleccionar...</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Fecha</label>
                                        <input type="date" class="form-control" id="transactionDate" required>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-9">
                                    <div class="form-group">
                                        <label class="form-label">Descripción</label>
                                        <input type="text" class="form-control" id="description"
                                            placeholder="Descripción opcional">
                                    </div>
                                </div>
                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-save"></i> Guardar
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <!-- Gráficas del dashboard -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie"></i> Gastos por Categoría</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="expenseChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-line"></i> Tendencia Mensual</h5>
                            </div>
                            <div class="card-body">
                                <div class="chart-container">
                                    <canvas id="trendChart"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Predicción de gastos -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-crystal-ball"></i> Predicción de Gastos</h5>
                    </div>
                    <div class="card-body">
                        <div id="predictionContent">
                            <button class="btn btn-info" onclick="loadPrediction()">
                                <i class="fas fa-magic"></i> Generar Predicción
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Transacciones -->
            <div class="tab-pane fade" id="transactions" role="tabpanel">
                <!-- Filtros -->
                <div class="filters">
                    <div class="filters-grid">
                        <div class="form-group">
                            <label class="form-label">Fecha Inicio</label>
                            <input type="date" class="form-control" id="filterStartDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Fecha Fin</label>
                            <input type="date" class="form-control" id="filterEndDate">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Categoría</label>
                            <select class="form-control form-select" id="filterCategory">
                                <option value="">Todas las categorías</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Tipo</label>
                            <select class="form-control form-select" id="filterType">
                                <option value="">Todos los tipos</option>
                                <option value="income">Ingresos</option>
                                <option value="expense">Gastos</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <button class="btn btn-primary w-100" onclick="applyFilters()">
                                <i class="fas fa-filter"></i> Aplicar Filtros
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tabla de transacciones -->
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Categoría</th>
                                <th>Descripción</th>
                                <th>Monto</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Las transacciones se cargarán aquí -->
                        </tbody>
                    </table>
                </div>

                <!-- Paginación -->
                <nav aria-label="Paginación de transacciones">
                    <ul class="pagination justify-content-center" id="pagination">
                        <!-- La paginación se generará aquí -->
                    </ul>
                </nav>
            </div>

            <!-- Reportes -->
            <div class="tab-pane fade" id="reports" role="tabpanel">
                <!-- Selector de mes/año -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-calendar"></i> Seleccionar Período</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Mes</label>
                                    <select class="form-control form-select" id="reportMonth">
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Año</label>
                                    <select class="form-control form-select" id="reportYear">
                                        <!-- Se llenará dinámicamente -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                <button class="btn btn-primary w-100" onclick="generateReport()">
                                    <i class="fas fa-chart-bar"></i> Generar Reporte
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Resumen del reporte -->
                <div id="reportSummary" class="d-none">
                    <div class="stats-grid">
                        <div class="stat-card income">
                            <div class="stat-value" id="reportIncome">$0.00</div>
                            <div class="stat-label">Ingresos</div>
                        </div>
                        <div class="stat-card expense">
                            <div class="stat-value" id="reportExpense">$0.00</div>
                            <div class="stat-label">Gastos</div>
                        </div>
                        <div class="stat-card balance">
                            <div class="stat-value" id="reportBalance">$0.00</div>
                            <div class="stat-label">Balance</div>
                        </div>
                    </div>

                    <!-- Gráficas del reporte -->
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-pie"></i> Distribución de Gastos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="reportExpenseChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header">
                                    <h5><i class="fas fa-chart-bar"></i> Distribución de Ingresos</h5>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="reportIncomeChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Importar/Exportar -->
            <div class="tab-pane fade" id="import-export" role="tabpanel">
                <div class="row">
                    <!-- Exportar -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-download"></i> Exportar Datos</h5>
                            </div>
                            <div class="card-body">
                                <p>Exporta tus transacciones a un archivo PDF con reporte estructurado de ingresos y
                                    gastos.</p>

                                <div class="form-group">
                                    <label class="form-label">Fecha Inicio (Opcional)</label>
                                    <input type="date" class="form-control" id="exportStartDate">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Fecha Fin (Opcional)</label>
                                    <input type="date" class="form-control" id="exportEndDate">
                                </div>

                                <button class="btn btn-success w-100" onclick="exportData()">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Importar -->
                    <div class="col-md-6">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-upload"></i> Importar Datos</h5>
                            </div>
                            <div class="card-body">
                                <p>Importa transacciones desde un archivo CSV. El archivo debe tener las columnas:
                                    Fecha, Tipo, Categoría, Monto, Descripción.</p>

                                <div class="form-group">
                                    <label class="form-label">Archivo CSV</label>
                                    <input type="file" class="form-control" id="importFile" accept=".csv"
                                        onchange="previewImport()">
                                </div>

                                <div id="importPreview" class="d-none">
                                    <h6>Vista previa:</h6>
                                    <div id="previewContent"></div>
                                </div>

                                <button class="btn btn-warning w-100" onclick="importData()" disabled id="importBtn">
                                    <i class="fas fa-file-import"></i> Importar Datos
                                </button>

                                <div class="mt-3">
                                    <small class="text-muted">
                                        <strong>Formato esperado:</strong><br>
                                        Fecha (YYYY-MM-DD), Tipo (income/expense), Categoría, Monto, Descripción
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Plantilla CSV -->
                <div class="card">
                    <div class="card-header">
                        <h5><i class="fas fa-file-alt"></i> Plantilla CSV</h5>
                    </div>
                    <div class="card-body">
                        <p>Descarga una plantilla CSV para facilitar la importación de datos.</p>
                        <button class="btn btn-info" onclick="downloadTemplate()">
                            <i class="fas fa-download"></i> Descargar Plantilla
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal para editar transacción -->
    <div class="modal" id="editModal">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Transacción</h5>
                <button type="button" class="modal-close" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="editTransactionForm">
                    <input type="hidden" id="editTransactionId">

                    <div class="form-group">
                        <label class="form-label">Tipo</label>
                        <select class="form-control form-select" id="editTransactionType" required>
                            <option value="income">Ingreso</option>
                            <option value="expense">Gasto</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Monto</label>
                        <input type="number" class="form-control" id="editAmount" step="0.01" min="0" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Categoría</label>
                        <select class="form-control form-select" id="editCategory" required>
                            <!-- Se llenará dinámicamente -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Fecha</label>
                        <input type="date" class="form-control" id="editTransactionDate" required>
                    </div>

                    <div class="form-group">
                        <label class="form-label">Descripción</label>
                        <input type="text" class="form-control" id="editDescription">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="updateTransaction()">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <!-- Alertas -->
    <div id="alertContainer" style="position: fixed; top: 20px; right: 20px; z-index: 1050; max-width: 400px;">
        <!-- Las alertas se mostrarán aquí -->
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Variables globales
        let currentUser = 1; // Simulamos usuario ID 1
        let categories = [];
        let transactions = [];
        let currentPage = 1;
        const itemsPerPage = 10;

        // Inicialización
        document.addEventListener('DOMContentLoaded', function () {
            initializeApp();
        });

        async function initializeApp() {
            // Configurar fecha actual
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('transactionDate').value = today;

            // Configurar años en el selector de reportes
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('reportYear');
            for (let year = currentYear - 5; year <= currentYear + 1; year++) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelect.appendChild(option);
            }

            // Configurar mes actual
            const currentMonth = new Date().getMonth() + 1;
            document.getElementById('reportMonth').value = currentMonth;

            // Cargar datos iniciales
            await loadCategories();
            await loadTransactions();
            await loadDashboard();

            // Configurar eventos
            setupEventListeners();
        }

        function setupEventListeners() {
            // Formulario de transacción
            document.getElementById('transactionForm').addEventListener('submit', handleTransactionSubmit);

            // Cambio de tipo de transacción
            document.getElementById('transactionType').addEventListener('change', updateCategoryOptions);
            document.getElementById('editTransactionType').addEventListener('change', updateEditCategoryOptions);

            // Tabs
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
                tab.addEventListener('shown.bs.tab', function (e) {
                    const target = e.target.getAttribute('data-bs-target');
                    if (target === '#transactions') {
                        loadTransactions();
                    }
                });
            });
        }

        // Gestión de categorías
        async function loadCategories() {
            try {
                const resp = await fetch('/api/finance/categories');
                if (!resp.ok) throw new Error(`Error ${resp.status}`);
                const json = await resp.json();
                const data = Array.isArray(json) ? json : (json.data || []);

                const iconMap = {
                    'Alimentación': 'fas fa-utensils',
                    'Transporte': 'fas fa-car',
                    'Vivienda': 'fas fa-home',
                    'Salud': 'fas fa-heartbeat',
                    'Entretenimiento': 'fas fa-gamepad',
                    'Educación': 'fas fa-graduation-cap',
                    'Compras': 'fas fa-shopping-bag',
                    'Servicios': 'fas fa-tools',
                    'Otros Gastos': 'fas fa-ellipsis-h',
                    'Salario': 'fas fa-money-bill-wave',
                    'Freelance': 'fas fa-laptop',
                    'Inversiones': 'fas fa-chart-line',
                    'Bonos': 'fas fa-gift',
                    'Otros Ingresos': 'fas fa-plus-circle'
                };

                categories = data.map(c => ({
                    id: c.id,
                    name: c.name,
                    type: c.type,
                    color: c.color,
                    icon: iconMap[c.name] || 'fas fa-circle'
                }));

                updateCategorySelects();
                showAlert('Categorías cargadas correctamente', 'success');
            } catch (error) {
                showAlert('Error al cargar categorías: ' + error.message, 'danger');
            }
        }

        function updateCategorySelects() {
            const selects = ['category', 'filterCategory', 'editCategory'];

            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                if (selectId === 'filterCategory') {
                    select.innerHTML = '<option value="">Todas las categorías</option>';
                } else {
                    select.innerHTML = '<option value="">Seleccionar...</option>';
                }

                categories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category.id;
                    option.textContent = category.name;
                    option.dataset.type = category.type;
                    select.appendChild(option);
                });
            });
        }

        function updateCategoryOptions() {
            const type = document.getElementById('transactionType').value;
            const categorySelect = document.getElementById('category');

            // Limpiar opciones
            categorySelect.innerHTML = '<option value="">Seleccionar...</option>';

            // Filtrar categorías por tipo
            const filteredCategories = categories.filter(cat => cat.type === type);

            filteredCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        function updateEditCategoryOptions() {
            const type = document.getElementById('editTransactionType').value;
            const categorySelect = document.getElementById('editCategory');

            // Limpiar opciones
            categorySelect.innerHTML = '<option value="">Seleccionar...</option>';

            // Filtrar categorías por tipo
            const filteredCategories = categories.filter(cat => cat.type === type);

            filteredCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name;
                categorySelect.appendChild(option);
            });
        }

        // Gestión de transacciones
        async function handleTransactionSubmit(e) {
            e.preventDefault();

            const formData = {
                type: document.getElementById('transactionType').value,
                amount: parseFloat(document.getElementById('amount').value),
                category_id: parseInt(document.getElementById('category').value),
                description: document.getElementById('description').value,
                transaction_date: document.getElementById('transactionDate').value
            };

            try {
                await addTransaction(formData);
                document.getElementById('transactionForm').reset();
                document.getElementById('transactionDate').value = new Date().toISOString().split('T')[0];
                await loadDashboard();
                showAlert('Transacción agregada correctamente', 'success');
            } catch (error) {
                showAlert('Error al agregar transacción: ' + error.message, 'danger');
            }
        }

        async function addTransaction(data) {
            const payload = {
                user_id: currentUser,
                amount: data.amount,
                type: data.type,
                category_id: data.category_id,
                description: data.description,
                transaction_date: data.transaction_date
            };
            const resp = await fetch('/api/finance/transactions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            if (!resp.ok) {
                const err = await resp.json().catch(() => ({ error: 'Error al crear transacción' }));
                throw new Error(err.error || `Error ${resp.status}`);
            }
            return await resp.json();
        }

        async function loadTransactions() {
            try {
                const resp = await fetch(`/api/finance/transactions/${currentUser}`);
                if (!resp.ok) throw new Error(`Error ${resp.status}`);
                const json = await resp.json();
                const data = json.data || [];
                transactions = data.map(t => {
                    // Intentar mapear a una categoría conocida por nombre
                    const cat = categories?.find(c => c.name === t.category_name);
                    return {
                        id: t.id,
                        user_id: currentUser,
                        amount: t.amount,
                        type: t.type,
                        category_id: cat?.id ?? null,
                        description: t.description,
                        transaction_date: t.transaction_date,
                        category_name: t.category_name,
                        category_color: t.category_color,
                        category_icon: cat?.icon || 'fas fa-circle'
                    };
                });
                displayTransactions();
                showAlert('Transacciones cargadas', 'info');
            } catch (error) {
                showAlert('Error al cargar transacciones: ' + error.message, 'danger');
            }
        }

        function displayTransactions() {
            const tbody = document.getElementById('transactionsTable');
            tbody.innerHTML = '';

            if (!transactions || transactions.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center">No hay transacciones registradas</td></tr>';
                return;
            }

            // Aplicar paginación
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const paginatedTransactions = transactions.slice(startIndex, endIndex);

            paginatedTransactions.forEach(transaction => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(transaction.transaction_date)}</td>
                    <td>
                        <span class="badge ${transaction.type === 'income' ? 'bg-success' : 'bg-danger'}">
                            ${transaction.type === 'income' ? 'Ingreso' : 'Gasto'}
                        </span>
                    </td>
                    <td>
                        <span class="category-badge" style="background-color: ${transaction.category_color}">
                            <i class="${transaction.category_icon}"></i>
                            ${transaction.category_name}
                        </span>
                    </td>
                    <td>${transaction.description || '-'}</td>
                    <td>
                        <span class="transaction-amount ${transaction.type}">
                            ${transaction.type === 'income' ? '+' : '-'}$${transaction.amount.toFixed(2)}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editTransaction(${transaction.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });

            updatePagination();
        }

        function updatePagination() {
            const totalPages = Math.ceil(transactions.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            if (totalPages <= 1) return;

            // Botón anterior
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage - 1) + ')">Anterior</a>';
            pagination.appendChild(prevLi);

            // Números de página
            for (let i = 1; i <= totalPages; i++) {
                const li = document.createElement('li');
                li.className = `page-item ${i === currentPage ? 'active' : ''}`;
                li.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + i + ')">' + i + '</a>';
                pagination.appendChild(li);
            }

            // Botón siguiente
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = '<a class="page-link" href="#" onclick="changePage(' + (currentPage + 1) + ')">Siguiente</a>';
            pagination.appendChild(nextLi);
        }

        function changePage(page) {
            if (page < 1 || page > Math.ceil(transactions.length / itemsPerPage)) return;
            currentPage = page;
            displayTransactions();
        }

        // Dashboard
        async function loadDashboard() {
            try {
                const currentDate = new Date();
                const currentMonth = currentDate.getMonth() + 1;
                const currentYear = currentDate.getFullYear();

                const resp = await fetch(`/api/finance/summary/${currentUser}/${currentYear}/${currentMonth}`);
                if (!resp.ok) throw new Error(`Error ${resp.status}`);
                const json = await resp.json();
                const summary = json.data || json;

                updateDashboardStats(summary);
                updateDashboardCharts(summary);

            } catch (error) {
                showAlert('Error al cargar dashboard: ' + error.message, 'danger');
            }
        }

        function calculateMonthlySummary(year, month) {
            if (!transactions) transactions = [];

            const monthlyTransactions = transactions.filter(t => {
                const date = new Date(t.transaction_date);
                return date.getFullYear() === year && date.getMonth() + 1 === month;
            });

            const totalIncome = monthlyTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);

            const totalExpense = monthlyTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);

            // Gastos por categoría
            const expensesByCategory = {};
            monthlyTransactions
                .filter(t => t.type === 'expense')
                .forEach(t => {
                    if (!expensesByCategory[t.category_name]) {
                        expensesByCategory[t.category_name] = {
                            amount: 0,
                            color: t.category_color
                        };
                    }
                    expensesByCategory[t.category_name].amount += t.amount;
                });

            // Ingresos por categoría
            const incomeByCategory = {};
            monthlyTransactions
                .filter(t => t.type === 'income')
                .forEach(t => {
                    if (!incomeByCategory[t.category_name]) {
                        incomeByCategory[t.category_name] = {
                            amount: 0,
                            color: t.category_color
                        };
                    }
                    incomeByCategory[t.category_name].amount += t.amount;
                });

            return {
                total_income: totalIncome,
                total_expense: totalExpense,
                balance: totalIncome - totalExpense,
                expenses_by_category: Object.entries(expensesByCategory).map(([name, data]) => ({
                    category: name,
                    amount: data.amount,
                    color: data.color
                })),
                income_by_category: Object.entries(incomeByCategory).map(([name, data]) => ({
                    category: name,
                    amount: data.amount,
                    color: data.color
                }))
            };
        }

        function updateDashboardStats(summary) {
            const totalIncome = typeof summary.total_income === 'number' ? summary.total_income : (typeof summary.income === 'number' ? summary.income : 0);
            const totalExpense = typeof summary.total_expense === 'number' ? summary.total_expense : (typeof summary.expense === 'number' ? summary.expense : 0);
            const balance = typeof summary.balance === 'number' ? summary.balance : (totalIncome - totalExpense);

            document.getElementById('totalIncome').textContent = '$' + totalIncome.toFixed(2);
            document.getElementById('totalExpense').textContent = '$' + totalExpense.toFixed(2);
            document.getElementById('balance').textContent = '$' + balance.toFixed(2);

            // Cambiar color del balance según si es positivo o negativo
            const balanceElement = document.getElementById('balance');
            balanceElement.style.color = balance >= 0 ? '#28a745' : '#dc3545';
        }

        function updateDashboardCharts(summary) {
            // Gráfica de gastos por categoría
            updateExpenseChart(summary.expenses_by_category);

            // Gráfica de tendencia (simplificada)
            updateTrendChart();
        }

        function updateExpenseChart(expenseData) {
            const ctx = document.getElementById('expenseChart').getContext('2d');

            // Destruir gráfica anterior si existe
            if (window.expenseChart instanceof Chart) {
                window.expenseChart.destroy();
            }

            if (expenseData.length === 0) {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay datos para mostrar', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            window.expenseChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: expenseData.map(item => item.category),
                    datasets: [{
                        data: expenseData.map(item => item.amount),
                        backgroundColor: expenseData.map(item => item.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    const value = context.parsed;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((value / total) * 100).toFixed(1);
                                    return context.label + ': $' + value.toFixed(2) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateTrendChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');

            // Destruir gráfica anterior si existe
            if (window.trendChart instanceof Chart) {
                window.trendChart.destroy();
            }

            // Generar datos de tendencia de los últimos 6 meses
            const months = [];
            const incomeData = [];
            const expenseData = [];

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(date.getMonth() - i);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                months.push(date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }));

                const summary = calculateMonthlySummary(year, month);
                incomeData.push(summary.total_income);
                expenseData.push(summary.total_expense);
            }

            window.trendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [
                        {
                            label: 'Ingresos',
                            data: incomeData,
                            borderColor: '#28a745',
                            backgroundColor: 'rgba(40, 167, 69, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'Gastos',
                            data: expenseData,
                            borderColor: '#dc3545',
                            backgroundColor: 'rgba(220, 53, 69, 0.1)',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Funciones de edición y eliminación
        function editTransaction(id) {
            const transaction = transactions.find(t => t.id === id);
            if (!transaction) return;

            document.getElementById('editTransactionId').value = transaction.id;
            document.getElementById('editTransactionType').value = transaction.type;
            document.getElementById('editAmount').value = transaction.amount;
            document.getElementById('editTransactionDate').value = transaction.transaction_date;
            document.getElementById('editDescription').value = transaction.description || '';

            // Actualizar categorías y seleccionar la actual
            updateEditCategoryOptions();
            setTimeout(() => {
                document.getElementById('editCategory').value = transaction.category_id;
            }, 100);

            document.getElementById('editModal').classList.add('show');
        }

        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        async function updateTransaction() {
            const id = parseInt(document.getElementById('editTransactionId').value);
            const updatedData = {
                type: document.getElementById('editTransactionType').value,
                amount: parseFloat(document.getElementById('editAmount').value),
                category_id: parseInt(document.getElementById('editCategory').value),
                description: document.getElementById('editDescription').value,
                transaction_date: document.getElementById('editTransactionDate').value
            };

            try {
                // Actualizar en la lista local
                const index = transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    const category = categories.find(c => c.id === updatedData.category_id);
                    transactions[index] = {
                        ...transactions[index],
                        ...updatedData,
                        category_name: category?.name || 'Sin categoría',
                        category_color: category?.color || '#6c757d',
                        category_icon: category?.icon || 'fas fa-circle'
                    };
                }

                closeEditModal();
                displayTransactions();
                await loadDashboard();
                showAlert('Transacción actualizada correctamente', 'success');
            } catch (error) {
                showAlert('Error al actualizar transacción: ' + error.message, 'danger');
            }
        }

        async function deleteTransaction(id) {
            if (!confirm('¿Estás seguro de que quieres eliminar esta transacción?')) return;

            try {
                // Eliminar de la lista local
                transactions = transactions.filter(t => t.id !== id);

                displayTransactions();
                await loadDashboard();
                showAlert('Transacción eliminada correctamente', 'success');
            } catch (error) {
                showAlert('Error al eliminar transacción: ' + error.message, 'danger');
            }
        }

        // Filtros
        function applyFilters() {
            const startDate = document.getElementById('filterStartDate').value;
            const endDate = document.getElementById('filterEndDate').value;
            const categoryId = document.getElementById('filterCategory').value;
            const type = document.getElementById('filterType').value;

            let filteredTransactions = [...transactions];

            if (startDate) {
                filteredTransactions = filteredTransactions.filter(t => t.transaction_date >= startDate);
            }

            if (endDate) {
                filteredTransactions = filteredTransactions.filter(t => t.transaction_date <= endDate);
            }

            if (categoryId) {
                filteredTransactions = filteredTransactions.filter(t => t.category_id == categoryId);
            }

            if (type) {
                filteredTransactions = filteredTransactions.filter(t => t.type === type);
            }

            // Temporalmente reemplazar las transacciones para mostrar filtradas
            const originalTransactions = transactions;
            transactions = filteredTransactions;
            currentPage = 1;
            displayTransactions();

            // Restaurar transacciones originales después de un tiempo
            setTimeout(() => {
                transactions = originalTransactions;
            }, 100);

            showAlert(`Filtros aplicados. Mostrando ${filteredTransactions.length} transacciones`, 'info');
        }

        // Reportes
        function generateReport() {
            const month = parseInt(document.getElementById('reportMonth').value);
            const year = parseInt(document.getElementById('reportYear').value);

            const summary = calculateMonthlySummary(year, month);

            // Actualizar estadísticas del reporte
            document.getElementById('reportIncome').textContent = '$' + summary.total_income.toFixed(2);
            document.getElementById('reportExpense').textContent = '$' + summary.total_expense.toFixed(2);
            document.getElementById('reportBalance').textContent = '$' + summary.balance.toFixed(2);

            // Cambiar color del balance
            const balanceElement = document.getElementById('reportBalance');
            balanceElement.style.color = summary.balance >= 0 ? '#28a745' : '#dc3545';

            // Actualizar gráficas del reporte
            updateReportCharts(summary);

            // Mostrar sección de reporte
            document.getElementById('reportSummary').classList.remove('d-none');

            showAlert(`Reporte generado para ${getMonthName(month)} ${year}`, 'success');
        }

        function updateReportCharts(summary) {
            // Gráfica de gastos
            updateReportExpenseChart(summary.expenses_by_category);

            // Gráfica de ingresos
            updateReportIncomeChart(summary.income_by_category);
        }

        function updateReportExpenseChart(expenseData) {
            const ctx = document.getElementById('reportExpenseChart').getContext('2d');

            if (window.reportExpenseChart instanceof Chart) {
                window.reportExpenseChart.destroy();
            }

            if (expenseData.length === 0) {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay gastos en este período', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            window.reportExpenseChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: expenseData.map(item => item.category),
                    datasets: [{
                        data: expenseData.map(item => item.amount),
                        backgroundColor: expenseData.map(item => item.color),
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateReportIncomeChart(incomeData) {
            const ctx = document.getElementById('reportIncomeChart').getContext('2d');

            if (window.reportIncomeChart instanceof Chart) {
                window.reportIncomeChart.destroy();
            }

            if (incomeData.length === 0) {
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('No hay ingresos en este período', ctx.canvas.width / 2, ctx.canvas.height / 2);
                return;
            }

            window.reportIncomeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: incomeData.map(item => item.category),
                    datasets: [{
                        label: 'Ingresos',
                        data: incomeData.map(item => item.amount),
                        backgroundColor: incomeData.map(item => item.color),
                        borderWidth: 1,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function (value) {
                                    return '$' + value.toFixed(0);
                                }
                            }
                        }
                    }
                }
            });
        }

        // Predicción
        async function loadPrediction() {
            try {
                const prediction = calculatePrediction();
                displayPrediction(prediction);
            } catch (error) {
                showAlert('Error al generar predicción: ' + error.message, 'danger');
            }
        }

        function calculatePrediction() {
            if (!transactions || transactions.length === 0) {
                return {
                    success: false,
                    error: 'No hay suficientes datos para generar una predicción'
                };
            }

            // Calcular gastos de los últimos 6 meses
            const monthlyExpenses = [];
            const currentDate = new Date();

            for (let i = 5; i >= 0; i--) {
                const date = new Date();
                date.setMonth(currentDate.getMonth() - i);
                const month = date.getMonth() + 1;
                const year = date.getFullYear();

                const summary = calculateMonthlySummary(year, month);
                monthlyExpenses.push(summary.total_expense);
            }

            // Calcular promedio y tendencia
            const average = monthlyExpenses.reduce((a, b) => a + b, 0) / monthlyExpenses.length;

            // Calcular tendencia simple (diferencia entre últimos 3 meses y primeros 3 meses)
            const firstHalf = monthlyExpenses.slice(0, 3).reduce((a, b) => a + b, 0) / 3;
            const secondHalf = monthlyExpenses.slice(3).reduce((a, b) => a + b, 0) / 3;
            const trend = secondHalf - firstHalf;

            const nextMonthPrediction = Math.max(0, average + trend);

            return {
                success: true,
                current_average: average,
                trend: trend,
                next_month_prediction: nextMonthPrediction,
                historical_data: monthlyExpenses.map((amount, index) => {
                    const date = new Date();
                    date.setMonth(currentDate.getMonth() - (5 - index));
                    return {
                        month: date.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' }),
                        amount: amount
                    };
                })
            };
        }

        function displayPrediction(prediction) {
            const container = document.getElementById('predictionContent');

            if (!prediction.success) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> ${prediction.error}
                    </div>
                `;
                return;
            }

            const trendIcon = prediction.trend > 0 ? 'fa-arrow-up text-danger' : 'fa-arrow-down text-success';
            const trendText = prediction.trend > 0 ? 'aumentando' : 'disminuyendo';

            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-value">$${prediction.current_average.toFixed(2)}</div>
                            <div class="stat-label">Promedio Mensual</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-value">
                                <i class="fas ${trendIcon}"></i> $${Math.abs(prediction.trend).toFixed(2)}
                            </div>
                            <div class="stat-label">Tendencia (${trendText})</div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card">
                            <div class="stat-value">$${prediction.next_month_prediction.toFixed(2)}</div>
                            <div class="stat-label">Predicción Próximo Mes</div>
                        </div>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h6>Datos Históricos:</h6>
                    <div class="row">
                        ${prediction.historical_data.map(data => `
                            <div class="col-md-2 mb-2">
                                <small class="text-muted">${data.month}</small><br>
                                <strong>$${data.amount.toFixed(2)}</strong>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div class="alert alert-info mt-3">
                    <i class="fas fa-info-circle"></i>
                    <strong>Nota:</strong> Esta predicción se basa en el promedio de gastos de los últimos 6 meses y la tendencia observada. 
                    Los resultados son estimativos y pueden variar según cambios en tus hábitos de gasto.
                </div>
            `;
        }

        // Importar/Exportar
        function exportData() {
            const startDate = document.getElementById('exportStartDate').value;
            const endDate = document.getElementById('exportEndDate').value;

            let dataToExport = [...(transactions || [])];

            // Aplicar filtros de fecha si están definidos
            if (startDate) {
                dataToExport = dataToExport.filter(t => t.transaction_date >= startDate);
            }

            if (endDate) {
                dataToExport = dataToExport.filter(t => t.transaction_date <= endDate);
            }

            if (dataToExport.length === 0) {
                showAlert('No hay transacciones para exportar en el rango seleccionado', 'warning');
                return;
            }

            // Preparar datos
            const incomes = dataToExport.filter(t => t.type === 'income');
            const expenses = dataToExport.filter(t => t.type === 'expense');
            const totalIncome = incomes.reduce((sum, t) => sum + Number(t.amount || 0), 0);
            const totalExpense = expenses.reduce((sum, t) => sum + Number(t.amount || 0), 0);
            const balance = totalIncome - totalExpense;

            // Generar PDF
            const { jsPDF } = window.jspdf || {};
            if (!jsPDF || !window.jspdf || !window.jspdf.jsPDF) {
                showAlert('Librería PDF no cargada. Verifica conexión a Internet.', 'warning');
                return;
            }
            const doc = new window.jspdf.jsPDF({ unit: 'pt', format: 'a4' });

            if (typeof doc.autoTable !== 'function') {
                showAlert('Plugin autoTable de jsPDF no está disponible. Verifica que se haya cargado.', 'warning');
                return;
            }

            // Encabezado
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(18);
            doc.text('Reporte de Ingresos y Gastos', 40, 40);
            doc.setFontSize(11);
            doc.setFont('helvetica', 'normal');
            const now = new Date();
            doc.text(`Generado: ${now.toLocaleString('es-ES')}`, 40, 60);
            doc.text(`Usuario: ${currentUser}`, 40, 76);
            if (startDate || endDate) {
                doc.text(`Rango: ${startDate || 'Inicio'} - ${endDate || 'Fin'}`, 40, 92);
            }

            // Resumen
            doc.setFont('helvetica', 'bold');
            doc.text('Resumen', 40, 120);
            doc.setFont('helvetica', 'normal');
            doc.text(`Ingresos: $${totalIncome.toFixed(2)}`, 40, 140);
            doc.text(`Gastos: $${totalExpense.toFixed(2)}`, 200, 140);
            doc.text(`Balance: $${balance.toFixed(2)}`, 360, 140);

            // Tabla de Ingresos
            const incomeRows = incomes.map(t => [
                formatDate(t.transaction_date),
                t.category_name || '(Sin categoría)',
                t.description || '-',
                `$${Number(t.amount).toFixed(2)}`
            ]);
            doc.setFont('helvetica', 'bold');
            doc.text('Ingresos', 40, 170);
            doc.setFont('helvetica', 'normal');
            doc.autoTable({
                startY: 180,
                head: [['Fecha', 'Categoría', 'Descripción', 'Monto']],
                body: incomeRows,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [40, 167, 69] }
            });

            // Tabla de Gastos
            const expenseRows = expenses.map(t => [
                formatDate(t.transaction_date),
                t.category_name || '(Sin categoría)',
                t.description || '-',
                `$${Number(t.amount).toFixed(2)}`
            ]);
            const afterIncomeY = doc.lastAutoTable?.finalY ? doc.lastAutoTable.finalY + 30 : 210;
            doc.setFont('helvetica', 'bold');
            doc.text('Gastos', 40, afterIncomeY);
            doc.setFont('helvetica', 'normal');
            doc.autoTable({
                startY: afterIncomeY + 10,
                head: [['Fecha', 'Categoría', 'Descripción', 'Monto']],
                body: expenseRows,
                styles: { fontSize: 10 },
                headStyles: { fillColor: [220, 53, 69] }
            });

            // Guardar documento
            doc.save('reporte_finanzas.pdf');
            showAlert('Reporte PDF generado correctamente', 'success');
        }

        function generateCSV(data) {
            const headers = ['Fecha', 'Tipo', 'Categoría', 'Monto', 'Descripción'];
            const rows = data.map(t => [
                t.transaction_date,
                t.type === 'income' ? 'Ingreso' : 'Gasto',
                t.category_name,
                t.amount.toFixed(2),
                t.description || ''
            ]);

            const csvContent = [headers, ...rows]
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            return csvContent;
        }

        function previewImport() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                document.getElementById('importPreview').classList.add('d-none');
                document.getElementById('importBtn').disabled = true;
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim());

                if (lines.length < 2) {
                    showAlert('El archivo CSV debe tener al menos una fila de datos además del encabezado', 'danger');
                    return;
                }

                // Mostrar vista previa
                const preview = document.getElementById('previewContent');
                preview.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    ${lines[0].split(',').map(header => `<th>${header.replace(/"/g, '')}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${lines.slice(1, 6).map(line => `
                                    <tr>
                                        ${line.split(',').map(cell => `<td>${cell.replace(/"/g, '')}</td>`).join('')}
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        ${lines.length > 6 ? `<small class="text-muted">... y ${lines.length - 6} filas más</small>` : ''}
                    </div>
                `;

                document.getElementById('importPreview').classList.remove('d-none');
                document.getElementById('importBtn').disabled = false;
            };

            reader.readAsText(file);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];

            if (!file) {
                showAlert('Por favor selecciona un archivo CSV', 'warning');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                const csv = e.target.result;
                processImportedData(csv);
            };

            reader.readAsText(file);
        }

        function processImportedData(csvContent) {
            try {
                const lines = csvContent.split('\n').filter(line => line.trim());
                const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim().toLowerCase());

                let importedCount = 0;
                const errors = [];

                for (let i = 1; i < lines.length; i++) {
                    try {
                        const values = lines[i].split(',').map(v => v.replace(/"/g, '').trim());

                        const dateIndex = headers.findIndex(h => h.includes('fecha'));
                        const typeIndex = headers.findIndex(h => h.includes('tipo'));
                        const categoryIndex = headers.findIndex(h => h.includes('categoría') || h.includes('categoria'));
                        const amountIndex = headers.findIndex(h => h.includes('monto') || h.includes('cantidad'));
                        const descriptionIndex = headers.findIndex(h => h.includes('descripción') || h.includes('descripcion'));

                        if (dateIndex === -1 || typeIndex === -1 || categoryIndex === -1 || amountIndex === -1) {
                            errors.push(`Fila ${i + 1}: Faltan columnas requeridas`);
                            continue;
                        }

                        const date = values[dateIndex];
                        const type = values[typeIndex].toLowerCase() === 'ingreso' ? 'income' : 'expense';
                        const categoryName = values[categoryIndex];
                        const amount = parseFloat(values[amountIndex]);
                        const description = descriptionIndex !== -1 ? values[descriptionIndex] : '';

                        // Validar datos
                        if (!date || isNaN(amount) || amount <= 0) {
                            errors.push(`Fila ${i + 1}: Datos inválidos`);
                            continue;
                        }

                        // Buscar categoría por nombre
                        const category = categories.find(c => c.name.toLowerCase() === categoryName.toLowerCase());
                        if (!category) {
                            errors.push(`Fila ${i + 1}: Categoría "${categoryName}" no encontrada`);
                            continue;
                        }

                        // Crear transacción
                        const transaction = {
                            id: Date.now() + i, // ID único
                            user_id: currentUser,
                            amount: amount,
                            type: type,
                            category_id: category.id,
                            description: description,
                            transaction_date: date,
                            category_name: category.name,
                            category_color: category.color,
                            category_icon: category.icon
                        };

                        transactions.unshift(transaction);
                        importedCount++;

                    } catch (error) {
                        errors.push(`Fila ${i + 1}: Error al procesar - ${error.message}`);
                    }
                }

                // Mostrar resultados
                if (importedCount > 0) {
                    showAlert(`${importedCount} transacciones importadas correctamente`, 'success');
                    loadDashboard();
                    displayTransactions();
                }

                if (errors.length > 0) {
                    showAlert(`Se encontraron ${errors.length} errores durante la importación`, 'warning');
                    console.log('Errores de importación:', errors);
                }

                // Limpiar formulario
                document.getElementById('importFile').value = '';
                document.getElementById('importPreview').classList.add('d-none');
                document.getElementById('importBtn').disabled = true;

            } catch (error) {
                showAlert('Error al procesar archivo CSV: ' + error.message, 'danger');
            }
        }

        function downloadTemplate() {
            const templateData = [
                ['Fecha', 'Tipo', 'Categoría', 'Monto', 'Descripción'],
                ['2024-01-15', 'Gasto', 'Alimentación', '25.50', 'Almuerzo en restaurante'],
                ['2024-01-16', 'Ingreso', 'Salario', '2500.00', 'Pago mensual'],
                ['2024-01-17', 'Gasto', 'Transporte', '15.00', 'Taxi al trabajo']
            ];

            const csvContent = templateData
                .map(row => row.map(field => `"${field}"`).join(','))
                .join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', 'plantilla_transacciones.csv');
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Plantilla CSV descargada correctamente', 'success');
        }

        // Funciones auxiliares
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('es-ES', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
        }

        function getMonthName(month) {
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            return months[month - 1];
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                 <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                 ${message}
                 <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
             `;
            alertContainer.appendChild(alertDiv);

            // Auto-remover después de 5 segundos
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }
    </script>
</body>

</html>